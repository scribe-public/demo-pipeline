name: Remediate Findings

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  prfindings:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set Product Version
        id: get_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Replace with your actual workflow file name
          WORKFLOW_FILE="build2gcr.yml"
      
          # Get workflow ID
          WORKFLOW_ID=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows | \
            jq -r ".workflows[] | select(.path == \".github/workflows/${WORKFLOW_FILE}\") | .id")
      
          echo "Workflow ID is: $WORKFLOW_ID"
      
          # Get the latest successful run number
          RUN_NUMBER=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?status=success&per_page=1" | \
            jq -r '.workflow_runs[0].run_number')
      
          echo "Latest successful run number is: $RUN_NUMBER"

          echo "PRODUCT_VERSION=$RUN_NUMBER" >> $GITHUB_ENV
          echo "PRODUCT_VERSION=$RUN_NUMBER" >> $GITHUB_OUTPUT

      - name: Create output directory
        run: mkdir -p ${{ github.workspace }}/prfindings-output

      - name: Make output directory world-writable
        run: chmod -R 777 ${{ github.workspace }}/prfindings-output

      - name: Fix output directory permissions
        run: |
          sudo chown -R 1000:1000 ${{ github.workspace }}/prfindings-output || true

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      - name: Create minimal config.yml and .env
        run: |
          echo "${{ secrets.DOTENV_FILE }}" > .env
          
            
      - name: Update PRODUCT_VERSION in config.yml
        run: |
          # Display the current content of config.yml
          cat config.yml
          
          # Replace PRODUCT_VERSION placeholder with the actual value
          sed -i "s/PRODUCT_VERSION/$PRODUCT_VERSION/g" config.yml
          
          # Display the updated config.yml
          echo "Updated config.yml:"
          cat config.yml

      - name: Create sample findings file
        run: |
          echo '{"_type": "https://in-toto.io/Statement/v0.1", "predicate": {"content": [{"id": "1", "severity": "high"}]}}' > sample_findings.json

      - name: Run prfindings findings processor
        uses: scribe-security/prfindings-action@main
        with:
          config_file: ./config.yml
          env_file: ./.env
          output_dir: ${{ github.workspace }}/prfindings-output
          params_envs: |
            GITHUB_TOKEN:${{ secrets.GITHUB_TOKEN }}

      - name: Upload prfindings output
        uses: actions/upload-artifact@v4
        with:
          name: prfindings-output
          path: ${{ github.workspace }}/prfindings-output